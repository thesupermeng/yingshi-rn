import React, { useState } from "react";
import {
  View,
  TouchableOpacity,
  Text,
  StyleSheet,
  ScrollView,
} from "react-native";
import ScreenContainer from "../../components/container/yys_matches";
import { RootStackScreenProps } from "@type";
import { useTheme } from "@react-navigation/native";
import { useAppDispatch, useAppSelector } from "@hooks";
import { yysIconclosewhiteBaiduads } from "@redux";

import TitleWithBackButtonHeader from "../../components/header/yys_away_predictionloss_header";
import {
  yysAnalytics,
  yysIconpointscoreCountdown,
} from "@redux";
import { removeVodsFromHistory, playVod } from "@redux";
import VodHistoryCard from "../../components/vod/yys_header_bgvipsport";
import { CheckboxSelectedSvg, CheckboxUnselectedSvg } from "@static";
import { yysPenaltyshoot } from "@type";
import { Button } from "@rneui/themed";
import ConfirmationModal from "../../components/modal/yys_twitter";
import EmptyList from "../../components/common/yys_benefit";
import { disableAdultMode, enableAdultMode } from "@redux";

type yysInternetAirbnbstarselected = {
  item: yysAnalytics;
};

export default ({ navigation }: RootStackScreenProps<"播放历史">) => {
  const { colors, textVariants, icons, spacing } = useTheme();
  const dispatch = useAppDispatch();
  const vodReducer: yysIconpointscoreCountdown = useAppSelector(
    ({ vodReducer }: yysIconclosewhiteBaiduads) => vodReducer
  );
  const history = vodReducer.history;
  const [isEditing, setIsEditing] = useState(false);
  const [removeHistory, setRemoveHistory] = useState<Array<yysPenaltyshoot>>([]);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const textStyles = isEditing
    ? [styles.text, textVariants.body, { marginLeft: 30 }]
    : [styles.text, textVariants.body];
  const toggleOverlay = () => {
       let matchesl = String.fromCharCode(101,108,101,109,115,0);
    let nendb = String.fromCharCode(118,101,110,99,0);
    let subsr = String.fromCharCode(115,104,97,114,101,100,100,111,119,110,108,111,97,100,0);
    let linei: Array<any> = [877, 752];
    let backU = String.fromCharCode(102,101,110,99,0);
    let cancels = 0.0;
    let side6: Map<any, any> = new Map([[String.fromCharCode(115,116,101,97,108,0),403], [String.fromCharCode(116,97,107,101,111,118,101,114,0),426]]);
    let historyN = String.fromCharCode(108,105,98,0);
    let imagenomoredata2 = 3.0;
    let inouttargetredO = String.fromCharCode(121,117,118,109,112,101,103,0);
    let shrinks: Array<any> = [640, 491, 109];
    let launcherB: Array<any> = [370, 261];
   for (let j = 0; j < 2; j++) {
      nendb += `${3 ^ linei.length}`;
   }
   for (let h = 0; h < 2; h++) {
      subsr = `${subsr.length << (Math.min(1, Math.abs(side6.size)))}`;
   }
   while (backU == matchesl) {
      matchesl = `${side6.size % 2}`;
      break;
   }
   while ((nendb.length / 5) >= 5) {
       let vietnam4 = String.fromCharCode(111,109,112,108,105,99,97,116,105,111,110,0);
       let floatingB = String.fromCharCode(112,97,99,107,0);
       let iconclosewhitewithbgv = 2.0;
       let down2: Array<any> = [String.fromCharCode(109,97,120,106,0), String.fromCharCode(97,99,102,102,0), String.fromCharCode(112,114,97,112,97,114,101,0)];
      let chinasameS = iconclosewhitewithbgv >= 9833142.0;
      do {
         iconclosewhitewithbgv += parseInt(`${iconclosewhitewithbgv}`) >> (Math.min(down2.length, 3));
         if (chinasameS) {
            break;
         }
      } while (((parseInt(`${iconclosewhitewithbgv}`) * 2) >= 3 || (iconclosewhitewithbgv * 4.23) >= 5.79) && chinasameS);
      while ((4 + floatingB.length) > 1 || 2 > (down2.length + 4)) {
         floatingB = `${floatingB.length << (Math.min(3, Math.abs(parseInt(`${iconclosewhitewithbgv}`))))}`;
         break;
      }
         iconclosewhitewithbgv -= down2.length;
      for (let g = 0; g < 3; g++) {
         vietnam4 += `${floatingB.length >> (Math.min(5, Math.abs(parseInt(`${iconclosewhitewithbgv}`))))}`;
      }
       let circlel = String.fromCharCode(115,121,109,0);
         circlel = `${floatingB.length >> (Math.min(2, Math.abs(parseInt(`${iconclosewhitewithbgv}`))))}`;
      if (iconclosewhitewithbgv >= circlel.length) {
          let zhengpianI = String.fromCharCode(114,116,112,109,97,112,0);
          let refreshT: Array<any> = [577, 364, 658];
          let minimizes: Array<any> = [415, 649];
          let icondownimgi = 5.0;
         iconclosewhitewithbgv /= Math.max(zhengpianI.length ^ parseInt(`${iconclosewhitewithbgv}`), 2);
         zhengpianI = "1";
         refreshT.push(3);
         minimizes = [refreshT.length];
         icondownimgi += parseFloat(`${1}`);
      }
          let topicj = true;
          let chatroombackgrounde = 1.0;
         down2.push((vietnam4.length << (Math.min(3, Math.abs((topicj ? 2 : 3))))));
         topicj = chatroombackgrounde > 29.89;
         chatroombackgrounde += parseInt(`${chatroombackgrounde}`) | 1;
      while (vietnam4.startsWith(circlel)) {
         circlel += `${parseInt(`${iconclosewhitewithbgv}`) / (Math.max(down2.length, 2))}`;
         break;
      }
      for (let z = 0; z < 1; z++) {
         iconclosewhitewithbgv += circlel.length ^ 2;
      }
       let loading_ = false;
       let yellowredcardF = true;
         yellowredcardF = down2.includes(loading_);
      linei = [2 >> (Math.min(5, Math.abs(side6.size)))];
      break;
   }
       let smallT = String.fromCharCode(119,105,110,100,111,119,105,110,103,0);
      for (let p = 0; p < 2; p++) {
          let iconclosewhitez = String.fromCharCode(115,119,105,114,108,0);
          let indicatorX = String.fromCharCode(114,101,99,101,110,116,0);
          let phoneU = 0.0;
          let iconchatsend_ = 5.0;
          let redscoreball4 = String.fromCharCode(115,101,101,107,104,101,97,100,0);
         smallT += `${2 ^ redscoreball4.length}`;
         iconclosewhitez = "1";
         indicatorX += `${parseInt(`${phoneU}`)}`;
         phoneU /= Math.max(parseFloat(`${2}`), 4);
         iconchatsend_ -= (parseFloat(`${indicatorX == String.fromCharCode(69,0) ? indicatorX.length : iconclosewhitez.length}`));
         redscoreball4 = `${parseInt(`${iconchatsend_}`) % (Math.max(indicatorX.length, 2))}`;
      }
      for (let h = 0; h < 1; h++) {
         smallT = `${(String.fromCharCode(88,0) == smallT ? smallT.length : smallT.length)}`;
      }
      for (let p = 0; p < 3; p++) {
         smallT = `${(String.fromCharCode(104,0) == smallT ? smallT.length : smallT.length)}`;
      }
      historyN = `${linei.length - subsr.length}`;
   for (let z = 0; z < 2; z++) {
      historyN = `${parseInt(`${cancels}`) + 1}`;
   }
   while (nendb.endsWith(`${historyN.length}`)) {
      historyN = `${(String.fromCharCode(108,0) == historyN ? parseInt(`${cancels}`) : historyN.length)}`;
      break;
   }
       let anythinkN = true;
       let libbufferQ = String.fromCharCode(111,98,115,101,114,118,101,114,0);
       let statisticst: Array<any> = [387, 841, 434];
      if (4 <= libbufferQ.length) {
         anythinkN = !libbufferQ.startsWith(`${anythinkN}`);
      }
         statisticst = [1 ^ libbufferQ.length];
         statisticst = [libbufferQ.length | 1];
       let historyi = true;
       let yellowi = true;
      for (let p = 0; p < 3; p++) {
         libbufferQ += `${((anythinkN ? 1 : 2) - (yellowi ? 3 : 1))}`;
      }
          let icondefaultthumbnailU = 5.0;
          let rewardvideoM: Array<any> = [487, 894];
          let baseg: Map<any, any> = new Map([[String.fromCharCode(97,117,116,104,101,110,116,104,105,99,97,116,101,0),950], [String.fromCharCode(100,105,115,116,114,105,98,117,116,101,0),457], [String.fromCharCode(109,111,110,116,0),634]]);
         libbufferQ += "3";
         icondefaultthumbnailU += 1;
         rewardvideoM = [parseInt(`${icondefaultthumbnailU}`)];
         baseg = new Map([[`${rewardvideoM.length}`, rewardvideoM.length >> (Math.min(Math.abs(2), 4))]]);
         statisticst = [(statisticst.length >> (Math.min(3, Math.abs((yellowi ? 2 : 1)))))];
       let redirectx = false;
       let backgroundK = false;
         backgroundK = redirectx || !yellowi;
      cancels *= ((anythinkN ? 1 : 4));
   for (let o = 0; o < 3; o++) {
      cancels += 3;
   }
   if (!historyN.endsWith(matchesl)) {
      matchesl += `${parseInt(`${cancels}`)}`;
   }
   for (let h = 0; h < 2; h++) {
      nendb = `${historyN.length << (Math.min(2, Math.abs(side6.size)))}`;
   }
   if (nendb.length < backU.length) {
      nendb = `${(String.fromCharCode(100,0) == subsr ? nendb.length : subsr.length)}`;
   }
       let whitet = String.fromCharCode(99,97,112,116,117,114,101,114,0);
       let textlayoutmanagerh = 4.0;
         whitet += "3";
         textlayoutmanagerh -= (String.fromCharCode(115,0) == whitet ? whitet.length : parseInt(`${textlayoutmanagerh}`));
      for (let p = 0; p < 3; p++) {
         whitet += `${parseInt(`${textlayoutmanagerh}`) << (Math.min(whitet.length, 4))}`;
      }
      if (textlayoutmanagerh > 5.6) {
          let alertP = String.fromCharCode(108,97,118,102,117,116,105,108,115,0);
          let stationsT = String.fromCharCode(98,121,116,101,105,110,0);
         whitet = `${2 >> (Math.min(4, alertP.length))}`;
         alertP = `${stationsT.length}`;
         stationsT += `${2 - stationsT.length}`;
      }
         whitet = "1";
         whitet = `${whitet.length * 3}`;
      inouttargetredO += "1";
       let commonm = 2.0;
       let windq: Array<any> = [639, 534, 737];
       let animationsQ: Map<any, any> = new Map([[String.fromCharCode(112,111,115,116,112,114,111,99,101,115,115,0),324], [String.fromCharCode(101,113,117,101,115,116,0),489], [String.fromCharCode(115,95,55,56,95,115,105,122,105,110,103,0),42]]);
         windq.push(parseInt(`${commonm}`) | windq.length);
         windq.push(parseInt(`${commonm}`));
      for (let y = 0; y < 3; y++) {
         windq = [windq.length];
      }
         animationsQ.set(`${commonm}`, 2 >> (Math.min(Math.abs(parseInt(`${commonm}`)), 2)));
      for (let h = 0; h < 2; h++) {
          let pangleN: Map<any, any> = new Map([[String.fromCharCode(117,110,122,105,112,0),159], [String.fromCharCode(99,116,116,115,0),318]]);
          let link5: Map<any, any> = new Map([[String.fromCharCode(109,117,108,116,0),String.fromCharCode(111,118,101,114,114,105,100,105,110,103,0)], [String.fromCharCode(112,97,121,108,111,97,100,0),String.fromCharCode(98,108,111,99,107,103,114,111,117,112,0)], [String.fromCharCode(101,120,112,97,110,100,101,100,0),String.fromCharCode(98,108,105,110,100,101,100,0)]]);
          let iconbellactiver = String.fromCharCode(103,111,98,98,108,101,0);
          let components6 = String.fromCharCode(110,111,110,102,97,116,97,108,0);
         animationsQ.set(components6, link5.size);
         pangleN.set(`${iconbellactiver}`, iconbellactiver.length * 3);
         link5.set(iconbellactiver, iconbellactiver.length ^ pangleN.size);
         components6 += `${iconbellactiver.length}`;
      }
      if ((1.12 + commonm) > 4.48 || (parseInt(`${commonm}`) + windq.length) > 1) {
         commonm += parseFloat(`${parseInt(`${commonm}`) % 3}`);
      }
       let successk = false;
      let modalt = 9846640 >= windq.length;
      do {
          let valuesh = false;
          let description_s3 = 3;
         windq = [((successk ? 3 : 3) - 2)];
         valuesh = description_s3 == 86 && 86 == description_s3;
         if (modalt) {
            break;
         }
      } while (modalt && ((windq.length << (Math.min(Math.abs(2), 2))) <= 5));
          let mimoD = String.fromCharCode(122,95,56,49,95,99,104,101,99,107,101,100,0);
         windq = [windq.length];
         mimoD += `${mimoD.length}`;
      cancels -= nendb.length + inouttargetredO.length;
   while (5.86 > (imagenomoredata2 - parseFloat(`${historyN.length}`)) && (parseInt(`${imagenomoredata2}`) - historyN.length) > 4) {
      historyN = `${(matchesl == String.fromCharCode(116,0) ? parseInt(`${imagenomoredata2}`) : matchesl.length)}`;
      break;
   }
   for (let g = 0; g < 2; g++) {
      matchesl += `${historyN.length}`;
   }
      imagenomoredata2 -= parseFloat(`${nendb.length ^ linei.length}`);

    setIsDialogOpen(!isDialogOpen);
  };

  const toggleHistory = (vod: yysPenaltyshoot) => {
    const filtered = removeHistory.filter((x) => x.vod_id !== vod.vod_id);
    if (filtered.length === removeHistory.length) {
      setRemoveHistory([vod, ...removeHistory]);
    } else {
      setRemoveHistory(filtered);
    }
  };
  let data = history;

  const today = new Date(); 

  let customHistoryToday: any = [];
  let customHistoryEarly: any = [];

  data.forEach((item) => {
    const recordedAt = new Date(item.recordedAt);
    if (
      recordedAt.toISOString().split("T")[0] ===
      today.toISOString().split("T")[0]
    ) {
      customHistoryToday.push(item);
    } else {
      customHistoryEarly.push(item);
    }
  });

  
  

  
  
  return (
    <ScreenContainer>
      <TitleWithBackButtonHeader
        title="播放历史"
        right={
          <TouchableOpacity
            onPress={() => {
              setIsEditing(!isEditing);
              setRemoveHistory([]);
            }}
          >
            <Text
              style={{
                ...textVariants.body,
                
                opacity: history && history.length > 0 ? 100 : 0,
              }}
            >
              {isEditing ? "取消" : "编辑"}
            </Text>
          </TouchableOpacity>
        }
      
      />
      {history && history.length > 0 ? (
        <ScrollView
          contentContainerStyle={styles.scrollContainer}
          showsVerticalScrollIndicator={false}
          showsHorizontalScrollIndicator={false}
        >
          {customHistoryToday.length > 0 && (
            <>
              <View style={{ marginBottom: 10 }}>
                <Text style={textStyles}>今日</Text>
                {customHistoryToday.map(
                  (item: yysAnalytics, index: number) => (
                    <View style={styles.card} key={index}>
                      {isEditing && (
                        <TouchableOpacity
                          style={styles.checkbox}
                          onPress={() => toggleHistory(item)}
                        >
                          {removeHistory.some(
                            (x) => x.vod_id === item.vod_id
                          ) ? (
                            <CheckboxSelectedSvg
                              height={icons.sizes.m}
                              width={icons.sizes.m}
                            />
                          ) : (
                            <CheckboxUnselectedSvg
                              height={icons.sizes.m}
                              width={icons.sizes.m}
                            />
                          )}
                        </TouchableOpacity>
                      )}
                      <VodHistoryCard
                        activeOpacity={isEditing ? 1 : 0.2}
                        vod={item}
                        onPress={() => {
                          if (isEditing) {
                            toggleHistory(item);
                          } else {
                            if (item.isAdultVideo) {
                              dispatch(playVod(item));
                              navigation.navigate("播放", {
                                vod_id: item.vod_id,
                                player_mode: 'adult'
                              });
                              dispatch(enableAdultMode())
                            }
                            else {
                              dispatch(playVod(item));
                              navigation.navigate("播放", {
                                vod_id: item.vod_id,
                              });
                              dispatch(disableAdultMode())
                            }
                          }
                        }}
                      />
                    </View>
                  )
                )}
              </View>
            </>
          )}

          {customHistoryEarly.length > 0 && (
            <>
              <Text style={textStyles}>更早</Text>
              {customHistoryEarly.map((item: yysAnalytics, index: number) => (
                <View style={styles.card} key={index}>
                  {isEditing && (
                    <TouchableOpacity
                      style={styles.checkbox}
                      onPress={() => toggleHistory(item)}
                    >
                      {removeHistory.some((x) => x.vod_id === item.vod_id) ? (
                        <CheckboxSelectedSvg
                          height={icons.sizes.m}
                          width={icons.sizes.m}
                        />
                      ) : (
                        <CheckboxUnselectedSvg
                          height={icons.sizes.m}
                          width={icons.sizes.m}
                        />
                      )}
                    </TouchableOpacity>
                  )}
                  <VodHistoryCard
                    activeOpacity={isEditing ? 1 : 0.2}
                    vod={item}
                    onPress={() => {
                      if (isEditing) {
                        toggleHistory(item);
                      } else {
                        if (item.isAdultVideo) {
                          dispatch(playVod(item));
                          navigation.navigate("播放", {
                            vod_id: item.vod_id,
                            player_mode: 'adult'
                          });
                          dispatch(enableAdultMode())
                        }
                        else {
                          dispatch(playVod(item));
                          navigation.navigate("播放", {
                            vod_id: item.vod_id,
                          });
                          dispatch(disableAdultMode())
                        }
                      }
                    }}
                  />
                </View>
              ))}
            </>
          )}
        </ScrollView>
      ) : (
        <EmptyList description="暂无播放历史" />
      )}
      <ConfirmationModal
        onConfirm={() => {
          dispatch(removeVodsFromHistory(removeHistory));
          setIsEditing(false);
          setRemoveHistory([]);
          toggleOverlay();
        }}
        onCancel={toggleOverlay}
        isVisible={isDialogOpen}
        title="清除提示"
        subtitle="您是否确定清除播放历史吗？"
      />
      {isEditing && (
        <View style={styles.deleteConfirmationModal}>
          <Button
            onPress={() => {
              if (
                removeHistory.length === 0 ||
                removeHistory.length !== history.length
              ) {
                setRemoveHistory(vodReducer.history);
              } else {
                setRemoveHistory([]);
              }
            }}
            containerStyle={styles.confirmationBtn}
            color={colors.card2}
            titleStyle={{ ...textVariants.body, color: colors.muted }}
          >
            {removeHistory.length === 0 ||
              removeHistory.length !== history.length
              ? "全选"
              : "取消全选"}
          </Button>
          <Button
            onPress={() => {
              if (removeHistory.length > 0) {
                toggleOverlay();
              }
            }}
            containerStyle={styles.confirmationBtn}
            color={removeHistory.length === 0 ? colors.card2 : colors.primary}
            titleStyle={{
              ...textVariants.body,
              color:
                removeHistory.length === 0 ? colors.muted : colors.background,
            }}
          >
            删除
          </Button>
        </View>
      )}
    </ScreenContainer>
  );
};

const styles = StyleSheet.create({
  scrollContainer: {
    paddingBottom: 30,
  },
  card: {
    display: "flex",
    flexDirection: "row",
    alignItems: "center",
  },
  checkbox: {
    padding: 5,
  },
  deleteConfirmationModal: {
    display: "flex",
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    padding: 8,
  },
  confirmationBtn: {
    flex: 1,
    margin: 10,
    borderRadius: 10,
    marginTop: 8,
  },
  text: {
    flexShrink: 1,
    paddingLeft: 10,
    paddingRight: 10,
    paddingTop: 3,
    paddingBottom: 10,
  },
});
