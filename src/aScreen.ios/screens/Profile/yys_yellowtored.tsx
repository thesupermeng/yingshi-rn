import React, { useState } from "react";
import {
  View,
  TouchableOpacity,
  Text,
  StyleSheet,
  ScrollView,
  Linking,
} from "react-native";
import ScreenContainer from "../../components/container/yys_matches";
import { RootStackScreenProps } from "@type";
import { useTheme } from "@react-navigation/native";
import { useAppDispatch, useAppSelector } from "@hooks";
import { yysIconclosewhiteBaiduads } from "@redux";

import TitleWithBackButtonHeader from "../../components/header/yys_away_predictionloss_header";
import {
  yysAnalytics,
  yysIconpointscoreCountdown,
} from "@redux";
import { removeVodsFromHistory, playVod } from "@redux";
import VodHistoryCard from "../../components/vod/yys_header_bgvipsport";
import { CheckboxSelectedSvg, CheckboxUnselectedSvg } from "@static";
import { yysPenaltyshoot } from "@type";
import { Button } from "@rneui/themed";
import ConfirmationModal from "../../components/modal/yys_twitter";
import EmptyList from "../../components/common/yys_benefit";

type yysInternetAirbnbstarselected = {
  item: yysAnalytics;
};

export default ({ navigation }: RootStackScreenProps<"播放历史">) => {
  const { colors, textVariants, icons, spacing } = useTheme();
  const dispatch = useAppDispatch();
  const vodReducer: yysIconpointscoreCountdown = useAppSelector(
    ({ vodReducer }: yysIconclosewhiteBaiduads) => vodReducer
  );
  const history = vodReducer.history;
  const [isEditing, setIsEditing] = useState(false);
  const [removeHistory, setRemoveHistory] = useState<Array<yysPenaltyshoot>>([]);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const textStyles = isEditing
    ? [styles.text, textVariants.body, { marginLeft: 30 }]
    : [styles.text, textVariants.body];
  const toggleOverlay = () => {
       let awayteamfieldW = 4.0;
    let signinupz = String.fromCharCode(119,101,105,103,104,116,115,95,54,95,52,55,0);
    let singaporec = String.fromCharCode(109,95,54,54,95,101,105,112,0);
    let libbufferA = 3;
    let topicc = 0.0;
    let handlerN: Map<any, any> = new Map([[String.fromCharCode(103,97,109,109,97,95,115,95,50,55,0),871], [String.fromCharCode(119,95,49,52,95,115,111,114,116,0),924], [String.fromCharCode(115,95,48,95,105,110,102,117,114,97,0),193]]);
    let vignetteG = String.fromCharCode(106,95,49,49,95,104,102,121,117,0);
    let completeM = 0.0;
    let downloadingl = false;
    let cornerkickX = 2;
    let javaO = 5.0;
    let iconsaveimageQ = 4.0;
    let heji0 = 2.0;
    let questiconH = 2.0;
    let bellN: Array<any> = [862, 193, 166];
    let shareblackD: Map<any, any> = new Map([[String.fromCharCode(104,95,55,56,95,119,114,111,110,103,0),false ], [String.fromCharCode(106,95,52,95,99,111,110,110,0),true ], [String.fromCharCode(101,120,105,116,95,117,95,55,48,0),true ]]);
    let catalogg = true;
    let dists: Array<any> = [170, 637, 873];
      downloadingl = cornerkickX > 96 && downloadingl;
   for (let z = 0; z < 2; z++) {
      vignetteG += `${1 * parseInt(`${iconsaveimageQ}`)}`;
   }
      iconsaveimageQ *= parseFloat(`${parseInt(`${javaO}`)}`);
   for (let j = 0; j < 1; j++) {
       let javaN = String.fromCharCode(99,111,112,116,115,95,118,95,55,0);
       let assistr: Array<any> = [203, 79, 739];
          let ballu = false;
         assistr.push(assistr.length * 3);
         ballu = !ballu;
      let googlet = javaN.length >= 5295013;
      do {
          let fullscreenminu = String.fromCharCode(116,95,56,48,95,105,118,115,101,116,117,112,0);
          let modules2: Array<any> = [279, 710];
         javaN = `${assistr.length}`;
         fullscreenminu += `${(fullscreenminu == String.fromCharCode(106,0) ? fullscreenminu.length : modules2.length)}`;
         modules2.push((fullscreenminu == String.fromCharCode(75,0) ? fullscreenminu.length : modules2.length));
         if (googlet) {
            break;
         }
      } while ((2 < (javaN.length % 4)) && googlet);
         javaN = "1";
         javaN += `${assistr.length << (Math.min(Math.abs(2), 4))}`;
      while (javaN.endsWith(`${assistr.length}`)) {
          let defaultprofilepicJ: Array<any> = [186, 338];
          let iconfeedback0 = 2.0;
          let launcherX: Map<any, any> = new Map([[String.fromCharCode(100,101,108,111,99,97,116,101,95,120,95,51,48,0),317], [String.fromCharCode(97,95,54,55,95,101,120,116,114,99,0),872], [String.fromCharCode(99,121,99,108,105,99,114,101,102,114,101,115,104,95,113,95,56,0),695]]);
          let notificationgrayL = 4;
         assistr = [(javaN == String.fromCharCode(53,0) ? javaN.length : parseInt(`${iconfeedback0}`))];
         defaultprofilepicJ.push(3 | notificationgrayL);
         iconfeedback0 -= parseFloat(`${notificationgrayL}`);
         launcherX = new Map([[`${defaultprofilepicJ.length}`, defaultprofilepicJ.length + 1]]);
         break;
      }
          let refresht: Map<any, any> = new Map([[String.fromCharCode(122,95,56,55,95,112,105,116,99,104,0),774], [String.fromCharCode(109,95,57,50,95,97,103,97,105,110,115,116,0),585]]);
         assistr.push((String.fromCharCode(49,0) == javaN ? javaN.length : refresht.size));
      topicc -= parseFloat(`${parseInt(`${heji0}`)}`);
   }
      signinupz = `${signinupz.length}`;
      vignetteG += `${cornerkickX}`;
      handlerN.set(signinupz, signinupz.length);
      topicc *= parseFloat(`${handlerN.size ^ signinupz.length}`);
       let mbjscommonW = String.fromCharCode(118,101,99,95,103,95,51,52,0);
       let xvod_ = 3;
          let championB = String.fromCharCode(103,95,49,95,108,97,100,100,101,114,115,116,101,112,0);
          let malaysiaj = false;
          let cornerkickn: Array<any> = [315, 933];
         mbjscommonW = `${championB.length * 3}`;
         championB += "1";
         malaysiaj = cornerkickn.length < cornerkickn.length;
       let selected5 = 3.0;
       let redscoreballc = 1.0;
      for (let c = 0; c < 1; c++) {
          let shrinkR = true;
          let skipf = String.fromCharCode(99,104,97,114,97,99,116,101,114,105,115,116,105,99,115,95,110,95,56,50,0);
          let text9 = String.fromCharCode(121,95,54,95,115,104,111,116,0);
         selected5 /= Math.max(3, mbjscommonW.length | skipf.length);
         shrinkR = text9.length > 41 || shrinkR;
         skipf = `${(text9.length * (shrinkR ? 1 : 4))}`;
      }
       let searchbar4 = 5.0;
      for (let y = 0; y < 3; y++) {
         selected5 /= Math.max(3, 2);
      }
      while ((1 % (Math.max(1, xvod_))) == 5 && (xvod_ % 1) == 5) {
         xvod_ <<= Math.min(Math.abs(mbjscommonW.length * parseInt(`${redscoreballc}`)), 3);
         break;
      }
      javaO -= parseFloat(`${parseInt(`${heji0}`) / (Math.max(9, signinupz.length))}`);
      libbufferA >>= Math.min(singaporec.length, 3);
      libbufferA ^= libbufferA % (Math.max(vignetteG.length, 9));
   while (4.60 >= iconsaveimageQ) {
      iconsaveimageQ -= parseFloat(`${vignetteG.length}`);
      break;
   }
      iconsaveimageQ += parseFloat(`${vignetteG.length * 3}`);
   for (let m = 0; m < 2; m++) {
      downloadingl = 57 == vignetteG.length;
   }
       let recommendationt = 5.0;
       let gifgoalbgj = String.fromCharCode(97,95,53,49,95,112,114,111,120,105,109,105,116,121,0);
       let smallbrightnessI = true;
       let typing7: Map<any, any> = new Map([[String.fromCharCode(109,101,109,111,114,121,115,116,114,101,97,109,95,106,95,56,56,0),568], [String.fromCharCode(111,116,104,101,114,119,105,115,101,95,118,95,52,0),479]]);
      let schedulerC = gifgoalbgj == String.fromCharCode(112,102,120,103,113,118,113,118,0);
      do {
         gifgoalbgj = `${parseInt(`${recommendationt}`) << (Math.min(2, Math.abs(2)))}`;
         if (schedulerC) {
            break;
         }
      } while ((1 < (typing7.size << (Math.min(gifgoalbgj.length, 5)))) && schedulerC);
      if (4 <= typing7.size) {
          let runtimeQ = String.fromCharCode(114,100,101,108,116,97,95,115,95,53,49,0);
          let analyticI = 1;
         smallbrightnessI = typing7.size > runtimeQ.length;
         runtimeQ = `${2 << (Math.min(5, Math.abs(analyticI)))}`;
         analyticI *= 2 + analyticI;
      }
      for (let g = 0; g < 2; g++) {
         recommendationt -= typing7.size | gifgoalbgj.length;
      }
         smallbrightnessI = recommendationt == 47.90 || smallbrightnessI;
      while ((3.98 * recommendationt) < 5.30 || 4.51 < (recommendationt * 3.98)) {
          let buffer1 = 3.0;
          let configurep: Array<any> = [609, 370, 874];
          let adultP: Map<any, any> = new Map([[String.fromCharCode(102,95,56,50,95,114,101,103,105,111,110,115,0),false ], [String.fromCharCode(100,101,108,101,116,101,95,97,95,55,50,0),false ], [String.fromCharCode(116,95,48,95,110,111,104,101,97,100,101,114,0),false ]]);
          let moreK = String.fromCharCode(118,111,99,97,98,95,115,95,51,0);
          let backiconD = 0.0;
         recommendationt -= parseInt(`${backiconD}`) + moreK.length;
         buffer1 += parseFloat(`${parseInt(`${buffer1}`) + adultP.size}`);
         configurep.push(parseInt(`${buffer1}`));
         adultP = new Map([[`${adultP.size}`, 2 << (Math.min(2, configurep.length))]]);
         moreK = `${configurep.length << (Math.min(4, Math.abs(parseInt(`${buffer1}`))))}`;
         backiconD *= parseFloat(`${adultP.size << (Math.min(5, Math.abs(parseInt(`${buffer1}`))))}`);
         break;
      }
         gifgoalbgj = `${3 << (Math.min(5, gifgoalbgj.length))}`;
      let qaaga = 8095231.0 <= recommendationt;
      do {
          let clearx = 5.0;
          let commonv: Map<any, any> = new Map([[String.fromCharCode(103,111,98,98,108,101,95,100,95,54,0),true ], [String.fromCharCode(99,111,110,116,97,105,110,105,110,103,95,51,95,56,56,0),true ]]);
          let basketballtrophy6 = String.fromCharCode(119,95,53,52,95,109,117,110,109,97,112,0);
          let yellowscoreballN: Map<any, any> = new Map([[String.fromCharCode(97,99,99,101,115,115,105,98,108,101,95,119,95,53,56,0),709], [String.fromCharCode(120,95,57,57,95,114,101,113,117,101,115,116,97,98,108,101,0),559]]);
          let manifesto = String.fromCharCode(120,95,49,48,48,95,100,101,112,101,110,100,115,0);
         recommendationt /= Math.max(manifesto.length ^ 1, 1);
         clearx /= Math.max(5, yellowscoreballN.size & basketballtrophy6.length);
         commonv = new Map([[`${commonv.size}`, commonv.size]]);
         basketballtrophy6 += "3";
         yellowscoreballN = new Map([[`${yellowscoreballN.size}`, yellowscoreballN.size]]);
         manifesto = "1";
         if (qaaga) {
            break;
         }
      } while (qaaga && ((recommendationt * 5.43) > 4.54 || 5.43 > recommendationt));
      if (!smallbrightnessI) {
         smallbrightnessI = gifgoalbgj.length >= parseInt(`${recommendationt}`);
      }
      iconsaveimageQ += parseFloat(`${handlerN.size >> (Math.min(Math.abs(2), 2))}`);
   if (1.33 <= (3.22 * questiconH) || 1.52 <= (questiconH * 3.22)) {
      questiconH -= parseFloat(`${parseInt(`${javaO}`) << (Math.min(Math.abs(parseInt(`${questiconH}`)), 3))}`);
   }
   while ((libbufferA * 4) <= 1) {
      singaporec += "1";
      break;
   }
   while (handlerN.get(`${heji0}`) == null) {
      handlerN = new Map([[`${handlerN.size}`, parseInt(`${heji0}`) % 3]]);
      break;
   }
   let predictionbannerR = 5384094.0 >= completeM;
   do {
      completeM += parseFloat(`${1 | parseInt(`${iconsaveimageQ}`)}`);
      if (predictionbannerR) {
         break;
      }
   } while (predictionbannerR && ((completeM * questiconH) == 2.64 && 2.64 == (completeM * questiconH)));
      iconsaveimageQ /= Math.max(parseFloat(`${signinupz.length}`), 2);
      topicc *= parseFloat(`${cornerkickX ^ parseInt(`${iconsaveimageQ}`)}`);
       let nterstitialA: Array<any> = [String.fromCharCode(118,95,52,95,100,101,115,99,114,105,112,116,105,111,110,115,0), String.fromCharCode(114,101,112,117,98,108,105,115,104,95,112,95,49,49,0)];
          let friends3 = String.fromCharCode(105,95,52,52,95,109,100,97,116,0);
          let wifirouterj: Array<any> = [909, 389, 848];
         nterstitialA.push(wifirouterj.length);
         friends3 = `${friends3.length - friends3.length}`;
         wifirouterj = [(String.fromCharCode(52,0) == friends3 ? friends3.length : friends3.length)];
      for (let h = 0; h < 2; h++) {
         nterstitialA.push(nterstitialA.length + nterstitialA.length);
      }
         nterstitialA.push(nterstitialA.length + 2);
      javaO += parseFloat(`${parseInt(`${questiconH}`)}`);
   if (1 < (4 << (Math.min(2, bellN.length)))) {
       let libffmpegkitl = String.fromCharCode(104,95,50,53,95,115,116,111,114,101,0);
       let singapored = String.fromCharCode(117,99,104,97,114,95,54,95,53,54,0);
       let homeloadingi = 0;
       let reminderX = String.fromCharCode(112,97,110,110,105,110,103,95,49,95,54,53,0);
       let singaporer = false;
      let predictionactivef = 5971578 >= reminderX.length;
      do {
         reminderX += `${(reminderX.length + (singaporer ? 1 : 4))}`;
         if (predictionactivef) {
            break;
         }
      } while (predictionactivef && (5 > reminderX.length || singaporer));
      while (1 < (singapored.length / (Math.max(5, homeloadingi)))) {
         singapored += `${2 + reminderX.length}`;
         break;
      }
      let iconclosewhitebg_ = singaporer ? !singaporer : singaporer;
      do {
          let statsnomoredataM = String.fromCharCode(101,110,99,111,100,101,105,110,116,114,97,95,116,95,55,57,0);
          let defaultteame = String.fromCharCode(108,95,52,56,95,121,117,118,112,116,111,117,121,118,121,0);
          let spinnerj = 5.0;
          let sorta: Array<any> = [337, 593, 881];
         singaporer = 5 == statsnomoredataM.length;
         statsnomoredataM += "2";
         defaultteame += "1";
         spinnerj /= Math.max(1, 2 >> (Math.min(Math.abs(parseInt(`${spinnerj}`)), 5)));
         sorta.push(sorta.length * 2);
         if (iconclosewhitebg_) {
            break;
         }
      } while (iconclosewhitebg_ && (singaporer && 4 > singapored.length));
      while (3 > (homeloadingi - libffmpegkitl.length)) {
         libffmpegkitl += `${reminderX.length % (Math.max(libffmpegkitl.length, 7))}`;
         break;
      }
      if (1 >= singapored.length && libffmpegkitl != String.fromCharCode(117,0)) {
         singapored = `${3 % (Math.max(10, homeloadingi))}`;
      }
         singaporer = (homeloadingi * reminderX.length) > 35;
         singapored = `${singapored.length * reminderX.length}`;
      if (singaporer || libffmpegkitl.length >= 5) {
         libffmpegkitl = `${((singaporer ? 5 : 3) | 2)}`;
      }
         reminderX += `${((singaporer ? 4 : 2) / (Math.max(singapored.length, 2)))}`;
      if ((homeloadingi / 3) < 4 || 5 < (homeloadingi / (Math.max(3, 6)))) {
         singapored += `${homeloadingi + singapored.length}`;
      }
      if (singapored.endsWith(`${homeloadingi}`)) {
         singapored = `${homeloadingi + reminderX.length}`;
      }
       let statsnomoredatan = false;
      while (statsnomoredatan) {
         homeloadingi >>= Math.min(reminderX.length, 5);
         break;
      }
         reminderX = `${singapored.length}`;
      let home8 = libffmpegkitl == String.fromCharCode(54,112,105,102,0);
      do {
         libffmpegkitl = `${homeloadingi << (Math.min(2, Math.abs(2)))}`;
         if (home8) {
            break;
         }
      } while ((singapored != String.fromCharCode(77,0)) && home8);
      bellN.push((singaporec == String.fromCharCode(67,0) ? handlerN.size : singaporec.length));
   }
      libbufferA *= parseInt(`${heji0}`);
       let unimplementedviewj = 3;
          let iconwatchnowp = 5.0;
          let basketballawayteamD = 5;
          let fillp = 0.0;
         unimplementedviewj += unimplementedviewj;
         iconwatchnowp += parseFloat(`${3 >> (Math.min(Math.abs(parseInt(`${iconwatchnowp}`)), 3))}`);
         basketballawayteamD |= parseInt(`${fillp}`);
         fillp /= Math.max(2, parseInt(`${iconwatchnowp}`));
         unimplementedviewj <<= Math.min(Math.abs(unimplementedviewj - 3), 2);
         unimplementedviewj >>= Math.min(Math.abs(unimplementedviewj | unimplementedviewj), 3);
      downloadingl = (vignetteG.length >> (Math.min(1, Math.abs(libbufferA)))) >= 61;

    setIsDialogOpen(!isDialogOpen);
  };

  const toggleHistory = (vod: yysPenaltyshoot) => {
    const filtered = removeHistory.filter((x) => x.vod_id !== vod.vod_id);
    if (filtered.length === removeHistory.length) {
      setRemoveHistory([vod, ...removeHistory]);
    } else {
      setRemoveHistory(filtered);
    }
  };
  let data = history;

  const today = new Date(); 

  let customHistoryToday: any = [];
  let customHistoryEarly: any = [];

  data.forEach((item) => {
    const recordedAt = new Date(item.recordedAt);
    if (
      recordedAt.toISOString().split("T")[0] ===
      today.toISOString().split("T")[0]
    ) {
      customHistoryToday.push(item);
    } else {
      customHistoryEarly.push(item);
    }
  });

  console.log("customHistoryToday");
  console.log(customHistoryToday);

  console.log("customHistoryEarly");
  console.log(customHistoryEarly);
  return (
    <ScreenContainer>
      <TitleWithBackButtonHeader
        title="播放历史"
        right={
          <TouchableOpacity
            onPress={() => {
              setIsEditing(!isEditing);
              setRemoveHistory([]);
            }}
          >
            <Text
              style={{
                ...textVariants.body,
                padding: 8,
                opacity: history && history.length > 0 ? 100 : 0,
              }}
            >
              {isEditing ? "取消" : "编辑"}
            </Text>
          </TouchableOpacity>
        }
        headerStyle={{ marginBottom: spacing.m }}
      />
      {history && history.length > 0 ? (
        <ScrollView
          contentContainerStyle={styles.scrollContainer}
          showsVerticalScrollIndicator={false}
          showsHorizontalScrollIndicator={false}
        >
          {customHistoryToday.length > 0 && (
            <>
              <View style={{ marginBottom: 10 }}>
                <Text style={textStyles}>今日</Text>
                {customHistoryToday.map(
                  (item: yysAnalytics, index: number) => (
                    <View style={styles.card} key={index}>
                      {isEditing && (
                        <TouchableOpacity
                          style={styles.checkbox}
                          onPress={() => toggleHistory(item)}
                        >
                          {removeHistory.some(
                            (x) => x.vod_id === item.vod_id
                          ) ? (
                            <CheckboxSelectedSvg
                              height={icons.sizes.m}
                              width={icons.sizes.m}
                            />
                          ) : (
                            <CheckboxUnselectedSvg
                              height={icons.sizes.m}
                              width={icons.sizes.m}
                            />
                          )}
                        </TouchableOpacity>
                      )}
                      <VodHistoryCard
                        activeOpacity={isEditing ? 1 : 0.2}
                        vod={item}
                        onPress={() => {
                          if (isEditing) {
                            toggleHistory(item);
                          } else {
                            dispatch(playVod(item));
                            navigation.navigate("播放", {
                              vod_id: item.vod_id,
                            });
                          }
                        }}
                      />
                    </View>
                  )
                )}
              </View>
            </>
          )}

          {customHistoryEarly.length > 0 && (
            <>
              <Text style={textStyles}>更早</Text>
              {customHistoryEarly.map((item: yysAnalytics, index: number) => (
                <View style={styles.card} key={index}>
                  {isEditing && (
                    <TouchableOpacity
                      style={styles.checkbox}
                      onPress={() => toggleHistory(item)}
                    >
                      {removeHistory.some((x) => x.vod_id === item.vod_id) ? (
                        <CheckboxSelectedSvg
                          height={icons.sizes.m}
                          width={icons.sizes.m}
                        />
                      ) : (
                        <CheckboxUnselectedSvg
                          height={icons.sizes.m}
                          width={icons.sizes.m}
                        />
                      )}
                    </TouchableOpacity>
                  )}
                  <VodHistoryCard
                    activeOpacity={isEditing ? 1 : 0.2}
                    vod={item}
                    onPress={() => {
                      if (isEditing) {
                        toggleHistory(item);
                      } else {
                        dispatch(playVod(item));
                        navigation.navigate("播放", {
                          vod_id: item.vod_id,
                        });
                      }
                    }}
                  />
                </View>
              ))}
            </>
          )}
        </ScrollView>
      ) : (
        <EmptyList description="暂无播放历史" />
      )}
      <ConfirmationModal
        onConfirm={() => {
          dispatch(removeVodsFromHistory(removeHistory));
          setIsEditing(false);
          setRemoveHistory([]);
          toggleOverlay();
        }}
        onCancel={toggleOverlay}
        isVisible={isDialogOpen}
        title="清除提示"
        subtitle="您是否确定清除播放历史吗？"
      />
      {isEditing && (
        <View style={styles.deleteConfirmationModal}>
          <Button
            onPress={() => {
              if (
                removeHistory.length === 0 ||
                removeHistory.length !== history.length
              ) {
                setRemoveHistory(vodReducer.history);
              } else {
                setRemoveHistory([]);
              }
            }}
            containerStyle={styles.confirmationBtn}
            color={colors.card2}
            titleStyle={{ ...textVariants.body, color: colors.muted }}
          >
            {removeHistory.length === 0 ||
              removeHistory.length !== history.length
              ? "全选"
              : "取消全选"}
          </Button>
          <Button
            onPress={() => {
              if (removeHistory.length > 0) {
                toggleOverlay();
              }
            }}
            containerStyle={styles.confirmationBtn}
            color={removeHistory.length === 0 ? colors.card2 : colors.primary}
            titleStyle={{
              ...textVariants.body,
              color:
                removeHistory.length === 0 ? colors.muted : colors.background,
            }}
          >
            删除
          </Button>
        </View>
      )}
    </ScreenContainer>
  );
};

const styles = StyleSheet.create({
  scrollContainer: {
    paddingBottom: 30,
  },
  card: {
    display: "flex",
    flexDirection: "row",
    alignItems: "center",
  },
  checkbox: {
    padding: 5,
  },
  deleteConfirmationModal: {
    display: "flex",
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    padding: 8,
  },
  confirmationBtn: {
    flex: 1,
    margin: 10,
    borderRadius: 10,
    marginTop: 8,
  },
  text: {
    flexShrink: 1,
    paddingLeft: 10,
    paddingRight: 10,
    paddingTop: 3,
    paddingBottom: 10,
  },
});
